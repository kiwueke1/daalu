---
- name: Set kubeconfig path
  ansible.builtin.set_fact:
    kubeconfig_path: "/var/lib/tmp/kubeconfig"

- name: Check cluster status using kubectl
  ansible.builtin.command: kubectl --kubeconfig {{ kubeconfig_path }} get nodes
  register: node_status
  changed_when: false
  ignore_errors: true

- name: Debug node status
  ansible.builtin.debug:
    var: node_status

- name: Check if nodes are available
  ansible.builtin.set_fact:
    all_ready: "{{ node_status.rc == 0 and node_status.stdout_lines | length > 0 }}"

- name: Debug all_ready status
  ansible.builtin.debug:
    var: all_ready

- name: Get list of machine names
  ansible.builtin.shell: kubectl --kubeconfig {{ kubeconfig_path }} get nodes -o name | cut -d'/' -f2
  register: machine_names
  changed_when: false
  when: all_ready
  ignore_errors: true

- name: Debug machine names
  ansible.builtin.debug:
    var: machine_names
  when: all_ready

- name: Initialize hosts entries list
  ansible.builtin.set_fact:
    hosts_entries: []
  when: all_ready

- name: Get IP addresses for each machine
  ansible.builtin.shell: "kubectl --kubeconfig ~/.kube/config get machines {{ item }} -o json | jq -r '.status.addresses[] | select(.type==\"InternalIP\") | .address'"
  register: ip_result
  changed_when: false
  with_items: "{{ machine_names.stdout_lines }}"
  when: all_ready

- name: Create hosts entries list
  ansible.builtin.set_fact:
    hosts_entries: "{{ hosts_entries + [{'ip': item.stdout, 'hostname': item.item}] }}"
  with_items: "{{ ip_result.results }}"
  when: all_ready and item.stdout != ''

- name: Clean up old entries from /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '.*openstack-infra-(control-plane|workers)-.*\.kez-ironcloud\.duckdns\.org$'
    state: absent
  when: all_ready

- name: Update /etc/hosts file with new entries
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ item.ip }} {{ item.hostname }} {{ item.hostname }}.kez-ironcloud.duckdns.org"
    regexp: '.*{{ item.hostname }}(\.kez-ironcloud\.duckdns\.org)?$'
    state: present
  with_items: "{{ hosts_entries }}"
  when: all_ready

- name: Read existing inventory file
  ansible.builtin.slurp:
    src: "{{ playbook_dir }}/inventory/hosts.ini"
  register: inventory_content
  when: all_ready

- name: Set inventory vars section
  ansible.builtin.set_fact:
    inventory_vars: |
      [servers:vars]
      ansible_user=ubuntulogin
      ansible_password=admin10
      ansible_become_password=admin10
  when: all_ready

- name: Create k8s section for inventory
  ansible.builtin.set_fact:
    k8s_inventory_section: |
      [k8s_cluster]
      {% for entry in hosts_entries %}
      {{ entry.hostname }} ansible_host={{ entry.ip }}
      {% endfor %}
  when: all_ready

- name: Get existing ens19 and ens20 addresses
  ansible.builtin.set_fact:
    network_configs:
      - "ens19_address=10.10.0.11/16 ens20_address=10.11.0.11/16"
      - "ens19_address=10.10.0.12/16 ens20_address=10.11.0.12/16"
      - "ens19_address=10.10.0.13/16 ens20_address=10.11.0.13/16"
      - "ens19_address=10.10.0.14/16 ens20_address=10.11.0.14/16"
      - "ens19_address=10.10.0.15/16 ens20_address=10.11.0.15/16"
      - "ens19_address=10.10.0.16/16 ens20_address=10.11.0.16/16"
      - "ens19_address=10.10.0.17/16 ens20_address=10.11.0.17/16"
      - "ens19_address=10.10.0.18/16 ens20_address=10.11.0.18/16"
      - "ens19_address=10.10.0.19/16 ens20_address=10.11.0.19/16"
  when: all_ready

- name: Generate ansible inventory content
  ansible.builtin.template:
    src: "{{ role_path }}/templates/hosts.ini.j2"
    dest: "{{ playbook_dir }}/inventory/hosts.ini"
    mode: '0644'
  when: all_ready

- name: Generate openstack inventory content
  ansible.builtin.template:
    src: "{{ role_path }}/templates/openstack_hosts.ini.j2"
    dest: "{{ playbook_dir }}/../../../cloud-config/inventory/hosts.ini"
    mode: '0644'
  when: all_ready

- name: Label nodes for Cilium bootstrap
  ansible.builtin.command: >
    kubectl --kubeconfig {{ kubeconfig_path }}
    label node {{ item.hostname }}
    node.cilium.io/agent-not-ready=true
    kubernetes.io/os=linux
    --overwrite
  with_items: "{{ hosts_entries }}"
  changed_when: false
  ignore_errors: true  # In case labels already exist

- name: Add taints for Cilium bootstrap
  ansible.builtin.command: >
    kubectl --kubeconfig {{ kubeconfig_path }}
    taint node {{ item.hostname }}
    node.cilium.io/agent-not-ready=true:NoSchedule
    --overwrite
  with_items: "{{ hosts_entries }}"
  changed_when: false
  ignore_errors: true  # In case taints already exist

# Optional: Remove the taint once Cilium agents are ready
- name: Remove Cilium bootstrap taints after agents become Ready
  ansible.builtin.command: >
    kubectl --kubeconfig {{ kubeconfig_path }}
    taint node {{ item.hostname }}
    node.cilium.io/agent-not-ready=true:NoSchedule-
  with_items: "{{ hosts_entries }}"
  when: cilium_ready | default(false)
  changed_when: false
  ignore_errors: true

