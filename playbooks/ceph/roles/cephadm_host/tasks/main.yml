# Copyright (c) 2023 VEXXHOST, Inc.
# Apache License, Version 2.0

- name: Debug _pxc_cluster
  debug:
    var: _pxc_cluster

- name: Debug number of PXC resources
  debug:
    msg: "Count: {{ _pxc_cluster.resources | length }}"
  when: _pxc_cluster is defined

- name: Get public SSH key and store fact if not set
  when: cephadm_host_public_key is not defined
  block:
    - name: Get public SSH key for "cephadm" user
      run_once: true
      changed_when: false
      delegate_to: "{{ cephadm_host_admin_host }}"
      ansible.builtin.command: cephadm shell -- ceph cephadm get-pub-key
      register: cephadm_host_public_key_command

    - name: Set fact with public SSH key for "cephadm" user
      run_once: true
      delegate_to: "{{ item }}"
      ansible.builtin.set_fact:
        cephadm_host_public_key: "{{ cephadm_host_public_key_command.stdout }}"
      loop: "{{ play_hosts }}"

- name: Set authorized key for "cephadm"
  ansible.posix.authorized_key:
    user: "{{ cephadm_host_user }}"
    state: present
    key: "{{ cephadm_host_public_key }}"

# ✅ NEW TASK: Also add key to root user for cephadm SSH
- name: Set authorized key for root (required for ceph orch)
  become: true
  ansible.posix.authorized_key:
    user: root
    state: present
    key: "{{ cephadm_host_public_key }}"

# ✅ Ensure orchestrator backend is set to cephadm
- name: Ensure cephadm is set as the orchestrator backend
  run_once: true
  delegate_to: "{{ cephadm_host_admin_host }}"
  ansible.builtin.command: cephadm shell -- ceph orch set backend cephadm
  register: orch_backend_result
  changed_when: "'Set backend to' in orch_backend_result.stdout or orch_backend_result.rc == 0"
  failed_when: orch_backend_result.rc != 0 and 'already' not in orch_backend_result.stderr

- name: Add new host to Ceph
  changed_when: false
  delegate_to: "{{ cephadm_host_admin_host }}"
  ansible.builtin.command:
    cmd: >
      cephadm shell -- ceph orch host add
      {{ inventory_hostname_short }}
      {{ ansible_all_ipv4_addresses | ansible.utils.ipaddr(ceph_mon_public_network) | first }}
      {% if cephadm_host_labels | length > 0 %}--labels={{ cephadm_host_labels | join(',') }}{% endif %}
