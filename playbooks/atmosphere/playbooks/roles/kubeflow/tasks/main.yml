---
- name: "Preflight | ensure kubectl is available locally"
  delegate_to: localhost
  run_once: true
  changed_when: false
  command: "which {{ kubeflow_kubectl_bin | default('kubectl') }}"

- name: "Preflight | ensure argocd CLI is available locally"
  delegate_to: localhost
  run_once: true
  changed_when: false
  command: "which {{ argocd_bin | default('argocd') }}"

# Optional: ensure the bundled script is executable where it sits
- name: "Ensure sync script is executable"
  delegate_to: localhost
  run_once: true
  file:
    path: "{{ role_path }}/files/sync_argocd_apps.sh"
    mode: "0755"
    state: file

- name: Apply Kubeflow Argo CD app (app-of-apps)
  kubernetes.core.k8s:
    state: present
    src: "../files/kubeflow.yaml"
    kubeconfig: "/etc/kubernetes/admin.conf"
  register: apply_kubeflow_argocd
  delegate_to: localhost
  run_once: true



# ---- Argo CD login (local) ----
# - name: "Argo CD login (token)"
#   delegate_to: localhost
#   run_once: true
#   no_log: true
#   when: (argocd_auth_token | default('')) | length > 0
#   command: >-
#     {{ argocd_bin | default('argocd') }} login {{ argocd_server }}
#     {{ '--insecure' if (argocd_insecure | default(true)) else '' }}
#     --grpc-web
#     --token {{ argocd_auth_token }}
#
# - name: "Argo CD login (username/password)"
#   delegate_to: localhost
#   run_once: true
#   no_log: true
#   when: (argocd_auth_token | default('')) | length == 0
#   command: >-
#     {{ argocd_bin | default('argocd') }} login {{ argocd_server }}
#     {{ '--insecure' if (argocd_insecure | default(true)) else '' }}
#     --grpc-web
#     --username {{ argocd_username }}
#     --password {{ argocd_password }}
#
# - name: "Argo CD whoami (verify CLI session)"
#   delegate_to: localhost
#   run_once: true
#   changed_when: false
#   command: >-
#     {{ argocd_bin | default('argocd') }} account get-user-info

#- name: "Sync Argo CD Apps (local CLI) and wait for Synced/Healthy"
#  delegate_to: localhost
#  run_once: true
#  environment:
#    KUBECONFIG: "{{ kubeflow_kubeconfig | default('') }}"
#    ARGOCD_NAMESPACE: "{{ kubeflow_argocd_namespace | default('argocd') }}"
#    APP_LABEL_SELECTOR: "{{ kubeflow_app_label_selector | default('') }}"
#    TIMEOUT_SECONDS: "{{ kubeflow_sync_timeout_seconds | default(900) }}"
#  command: "{{ role_path }}/files/sync_argocd_apps.sh"
