# Default variables (chart paths, namespaces, values, gateways)
# SPDX-License-Identifier: Apache-2.0

# Where your local Istio charts live (adjust to your path)
istio_charts_base_path: "../../charts/istio"
# Kubeconfig used by helm module
istio_helm_kubeconfig: "{{ kubeconfig_path | default('/etc/kubernetes/admin.conf') }}"

# Chart paths (local)
istio_base_chart_path: "../{{ istio_charts_base_path }}/base"
istio_istiod_chart_path: "../{{ istio_charts_base_path }}/istiod"
istio_gateway_chart_path: "../{{ istio_charts_base_path }}/gateway"

# On-host destination paths (where upload_helm_chart puts them)
istio_base_chart_ref: "/usr/local/src/istio/base"
istio_istiod_chart_ref: "/usr/local/src/istio/istiod"
istio_gateway_chart_ref: "/usr/local/src/istio/gateway"
istio_charts_ref: "/usr/local/src/istio"

# Release names/namespaces
istio_base_release_name: istio-base
istio_base_namespace: istio-system
istio_istiod_release_name: istiod
istio_istiod_namespace: istio-system

# Gateways to deploy (ingress by default)
istio_gateways:
  - name: istio-ingressgateway
    namespace: istio-ingress
    values:
      service:
        type: LoadBalancer
      labels:
        istio: ingressgateway

# Values for each component
istio_base_values: {}
istio_istiod_values: {}
istio_gateway_values_default: {}

# Helm install behavior
istio_helm_wait: true
istio_helm_timeout: 600s

# Optional Argo CD onboarding
github_token: ""
istio_argocd_repo_owner: "kiwueke1"
istio_argocd_repo_name: "argocd-infrastructure-app"
istio_argocd_apps:
  base: "apps/istio/base.yaml"
  istiod: "apps/istio/istiod.yaml"

# Shared gateway definition reused by all apps
_istio_shared_gateway:
  name: gateway
  namespace: istio-ingress
  selector:
    istio: ingressgateway
  tls:
    mode: SIMPLE
    credentialName: daalu-io-tls
  http_redirect_port_80_to_443: true

# === Istio traffic objects (Gateway, VirtualService, DestinationRule) ===
# Hostnames are read from endpoints.yml and sanitized (strip scheme/path).
istio_applications:
  # Keycloak
  - name: keycloak
    hostnames:
      - "{{ (keycloak_host | default('keycloak.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: auth-system
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: keycloak
      port: 80
      subset: ""
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Keystone (identity)
  - name: keystone
    hostnames:
      - "{{ (openstack_helm_endpoints_keystone_api_host | default('identity.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: keystone-api
      port: 5000
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Horizon (dashboard)
  - name: horizon
    hostnames:
      - "{{ (openstack_helm_endpoints_horizon_api_host | default('dashboard.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: horizon
      port: 80
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Glance (image)
  - name: glance
    hostnames:
      - "{{ (openstack_helm_endpoints_glance_api_host | default('image.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: glance-api
      port: 9292
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Nova API (compute)
  - name: nova
    hostnames:
      - "{{ (openstack_helm_endpoints_nova_api_host | default('compute.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: nova-api
      port: 8774
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Nova noVNC
  - name: nova-novnc
    hostnames:
      - "{{ (openstack_helm_endpoints_nova_novnc_host | default('vnc.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: nova-novncproxy
      port: 6080
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Neutron (network)
  - name: neutron
    hostnames:
      - "{{ (openstack_helm_endpoints_neutron_api_host | default('network.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: neutron-server
      port: 9696
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Cinder (volume)
  - name: cinder
    hostnames:
      - "{{ (openstack_helm_endpoints_cinder_api_host | default('volume.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: cinder-api
      port: 8776
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Placement
  - name: placement
    hostnames:
      - "{{ (openstack_helm_endpoints_placement_api_host | default('placement.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: placement-api
      port: 8778
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Barbican (key-manager)
  - name: barbican
    hostnames:
      - "{{ (openstack_helm_endpoints_barbican_api_host | default('key-manager.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: barbican-api
      port: 9311
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Octavia (load-balancer)
  - name: octavia
    hostnames:
      - "{{ (openstack_helm_endpoints_octavia_api_host | default('load-balancer.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: octavia-api
      port: 9876
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Heat (orchestration) — public API 8004
  - name: heat
    hostnames:
      - "{{ (openstack_helm_endpoints_heat_api_host | default('orchestration.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: heat-api
      port: 8004
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Heat CFN (cloudformation) — 8000
  - name: heat-cfn
    hostnames:
      - "{{ (openstack_helm_endpoints_heat_cfn_api_host | default('cloudformation.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: heat-cfn
      port: 8000
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Magnum (container-infra)
  - name: magnum
    hostnames:
      - "{{ (openstack_helm_endpoints_magnum_api_host | default('container-infra.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: magnum-api
      port: 9511
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Manila (share)
  - name: manila
    hostnames:
      - "{{ (openstack_helm_endpoints_manila_api_host | default('share.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: manila-api
      port: 8786
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Ironic (baremetal)
  - name: ironic
    hostnames:
      - "{{ (openstack_helm_endpoints_ironic_api_host | default('baremetal.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: openstack
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: ironic-api
      port: 6385
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # RGW (object-store) — adjust port/name to your deployment
  - name: rgw
    hostnames:
      - "{{ (openstack_helm_endpoints_rgw_host | default('object-store.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: rook-ceph
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: rook-ceph-rgw
      port: 8080
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  # Observability — Grafana/Prometheus/Alertmanager
  - name: grafana
    hostnames:
      - "{{ (kube_prometheus_stack_grafana_host | default('grafana.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: monitoring
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: kube-prometheus-stack-grafana
      port: 80
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  - name: prometheus
    hostnames:
      - "{{ (kube_prometheus_stack_prometheus_host | default('prometheus.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: monitoring
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: kube-prometheus-stack-prometheus
      port: 9090
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE

  - name: alertmanager
    hostnames:
      - "{{ (kube_prometheus_stack_alertmanager_host | default('alertmanager.daalu.io')) | regex_replace('^https?://','') | regex_replace('/.*$','') }}"
    traffic_namespace: istio-ingress
    original_svc_namespace: monitoring
    gateway: "{{ _istio_shared_gateway }}"
    service:
      name: kube-prometheus-stack-alertmanager
      port: 9093
    destinationrule:
      trafficPolicy:
        tls:
          mode: DISABLE
