# Ensure namespaces exist (idempotent)
- name: Ensure traffic namespace exists ({{ item.traffic_namespace }})
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item.traffic_namespace }}"
    kubeconfig: "{{ istio_helm_kubeconfig }}"
  loop: "{{ istio_applications | default([]) }}"
  loop_control:
    label: "{{ item.traffic_namespace }}"

# Create/Ensure the Gateway
- name: Ensure Gateway for {{ item.name }}
  kubernetes.core.k8s:
    state: present
    definition: >-
      {{
        {
          "apiVersion": "networking.istio.io/v1beta1",
          "kind": "Gateway",
          "metadata": {
            "name": item.gateway.name,
            "namespace": item.gateway.namespace
          },
          "spec": {
            "selector": item.gateway.selector,
            "servers": (
              (
                [
                  {
                    "port": {"number": 80, "name": "http", "protocol": "HTTP"},
                    "hosts": item.hostnames,
                    "tls": None,
                    "tlsRedirect": True
                  }
                ] if (item.gateway.http_redirect_port_80_to_443 | default(True)) else []
              )
              +
              [
                {
                  "port": {"number": 443, "name": "https", "protocol": "HTTPS"},
                  "hosts": item.hostnames,
                  "tls": {
                    "mode": item.gateway.tls.mode | default("SIMPLE"),
                    "credentialName": item.gateway.tls.credentialName
                  }
                }
              ]
            )
          }
        }
      }}
    kubeconfig: "{{ istio_helm_kubeconfig }}"
  loop: "{{ istio_applications | default([]) }}"
  loop_control:
    label: "{{ item.gateway.namespace }}/{{ item.gateway.name }}"

# Create/Ensure the DestinationRule
- name: Ensure DestinationRule for {{ item.name }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.istio.io/v1beta1
      kind: DestinationRule
      metadata:
        name: "{{ item.name }}-dr"
        namespace: "{{ item.traffic_namespace }}"
      spec:
        host: "{{ item.service.name }}.{{ item.original_svc_namespace }}.svc.cluster.local"
        trafficPolicy: "{{ item.destinationrule.trafficPolicy | default({}) }}"
        subsets: >-
          {{
            [] if (not item.service.subset) else
            [{"name": item.service.subset, "labels": {"version": item.service.subset}}]
          }}
    kubeconfig: "{{ istio_helm_kubeconfig }}"
  loop: "{{ istio_applications | default([]) }}"
  loop_control:
    label: "{{ item.name }}-dr"

# Create/Ensure the VirtualService
- name: Ensure VirtualService for {{ item.name }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.istio.io/v1beta1
      kind: VirtualService
      metadata:
        name: "{{ item.name }}-vs"
        namespace: "{{ item.traffic_namespace }}"
      spec:
        hosts: "{{ item.hostnames }}"
        gateways:
          - "{{ item.gateway.namespace }}/{{ item.gateway.name }}"
        http:
          - match:
              - uri:
                  prefix: /
            route:
              - destination: >-
                  {{
                    {
                      "host": item.service.name ~ "." ~ item.original_svc_namespace ~ ".svc.cluster.local",
                      "port": {"number": (item.service.port | int)}
                    }
                    | combine(
                        {"subset": item.service.subset}
                        if (item.service.subset | default("") | length > 0)
                        else {},
                        recursive=True
                      )
                  }}
    kubeconfig: "{{ istio_helm_kubeconfig }}"
  loop: "{{ istio_applications | default([]) }}"
  loop_control:
    label: "{{ item.name }}-vs"
