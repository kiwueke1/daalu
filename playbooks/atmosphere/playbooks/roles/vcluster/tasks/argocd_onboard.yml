---
- name: Check if vcluster is already added to Argo CD
  ansible.builtin.debug:
    msg: "vcluster already onboarded to Argo CD"
  when: "'vcluster' in argocd_apps_list | map('lower') | list"
  delegate_to: localhost
  run_once: true

- name: Download and apply vcluster Argo CD app if not already present
  block:
    - name: Wait for Argo CD CRDs to be available
      kubernetes.core.k8s_info:
        api_version: apiextensions.k8s.io/v1
        kind: CustomResourceDefinition
        name: applications.argoproj.io
        kubeconfig: "{{ vcluster_kubeconfig }}"
      register: argocd_crd
      until: argocd_crd.resources is defined and (argocd_crd.resources | length > 0)
      retries: 30
      delay: 10
      delegate_to: localhost
      run_once: true

    - name: Download Argo CD app manifest via GitHub v3 API
      ansible.builtin.uri:
        url: "{{ vcluster_argocd_app_repo_url }}"
        method: GET
        return_content: true
        headers:
          Accept: "application/vnd.github.v3.raw"
          Authorization: "token {{ github_token }}"
      register: vcluster_raw_yaml
      delegate_to: localhost
      run_once: true

    - name: Write Argo CD app manifest to file
      ansible.builtin.copy:
        dest: /tmp/vcluster-argocd-app.yaml
        content: "{{ vcluster_raw_yaml.content }}"
      delegate_to: localhost
      run_once: true

    - name: Apply vcluster Argo CD app
      kubernetes.core.k8s:
        state: present
        src: /tmp/vcluster-argocd-app.yaml
        kubeconfig: "{{ vcluster_kubeconfig }}"
      register: apply_vcluster_argocd
      delegate_to: localhost
      run_once: true

  when: "'vcluster' not in argocd_apps_list | map('lower') | list"
