- name: Check if Placement is already added to Argo CD
  ansible.builtin.debug:
    msg: "Placement already onboarded to Argo CD"
  when: "'placement' in argocd_apps_list | map('lower') | list"
  delegate_to: localhost
  run_once: true

- name: Download and apply Placement Argo CD app if not already present
  block:
    - name: Download Argo CD app manifest via GitHub v3 API
      ansible.builtin.uri:
        url: "https://api.github.com/repos/kiwueke1/argocd-infrastructure-app/contents/apps/openstack/placement/placement.yaml"
        method: GET
        return_content: true
        headers:
          Accept: "application/vnd.github.v3.raw"
          Authorization: "token {{ github_token }}"
      register: placement_raw_yaml
      delegate_to: localhost
      run_once: true

    - name: Write Argo CD app manifest to file
      ansible.builtin.copy:
        dest: /tmp/placement-argocd-app.yaml
        content: "{{ placement_raw_yaml.content }}"
      delegate_to: localhost
      run_once: true

    - name: Apply Placement Argo CD app
      ansible.builtin.command:
        cmd: kubectl apply --kubeconfig {{ kubeconfig_path_local }} -f /tmp/placement-argocd-app.yaml
      register: apply_placement_argocd
      changed_when: "'configured' in apply_placement_argocd.stdout or 'created' in apply_placement_argocd.stdout"
      delegate_to: localhost
      run_once: true

  when: "'placement' not in argocd_apps_list | map('lower') | list"
