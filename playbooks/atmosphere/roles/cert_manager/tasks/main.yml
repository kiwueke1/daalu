# Copyright (c) 2023 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Deploy Helm chart
  ansible.builtin.include_role:
    name: vexxhost.kubernetes.cert_manager
  vars:
    cert_manager_image_cli: "{{ atmosphere_images['cert_manager_cli'] }}"
    cert_manager_image_controller: "{{ atmosphere_images['cert_manager_controller'] }}"
    cert_manager_image_cainjector: "{{ atmosphere_images['cert_manager_cainjector'] }}"
    cert_manager_image_webhook: "{{ atmosphere_images['cert_manager_webhook'] }}"
    cert_manager_image_acmesolver: "{{ atmosphere_images['cert_manager_acmesolver'] }}"
    cert_manager_node_selector:
      openstack-control-plane: enabled

- name: Create Cloudflare API token secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: cloudflare-api-token-secret
        namespace: cert-manager
      type: Opaque
      stringData:
        api-token: "{{ cert_manager_cloudflare_api_token }}"
    kubeconfig: "{{ kubeconfig_path | default('/etc/kubernetes/admin.conf') }}"
- name: Create ClusterIssuers (staging and prod)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: "{{ item.name }}"
      spec:
        acme:
          email: "{{ cert_manager_email }}"
          server: "{{ item.server }}"
          privateKeySecretRef:
            name: "{{ item.name }}"
            key: tls.key
          solvers:
            - dns01:
                cloudflare:
                  apiTokenSecretRef:
                    name: cloudflare-api-token-secret
                    key: api-token
              selector:
                dnsZones: "{{ cert_manager_dns_zones }}"
    kubeconfig: "{{ kubeconfig_path | default('/etc/kubernetes/admin.conf') }}"
  loop:
    - { name: "letsencrypt-staging", server: "https://acme-staging-v02.api.letsencrypt.org/directory" }
    - { name: "letsencrypt-prod",    server: "https://acme-v02.api.letsencrypt.org/directory" }

- name: Ensure namespaces for Certificates exist
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ item }}"          # <â€” item is already the namespace string
    kubeconfig: "{{ kubeconfig_path | default('/etc/kubernetes/admin.conf') }}"
  loop: "{{ cert_manager_certificates
            | map(attribute='namespace')
            | select('defined')
            | list
            | unique }}"
  loop_control:
    label: "{{ item }}"


# Create/Update Certificates
- name: Create Certificates for services
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: "{{ item.name }}"
        namespace: "{{ item.namespace }}"
      spec:
        secretName: "{{ item.secret_name }}"
        dnsNames: "{{ item.dns_names }}"
        issuerRef:
          kind: "{{ item.issuer.kind | default('ClusterIssuer') }}"
          name: "{{ item.issuer.name }}"
    kubeconfig: "{{ kubeconfig_path | default('/etc/kubernetes/admin.conf') }}"
  loop: "{{ cert_manager_certificates }}"
  loop_control:
    label: "{{ item.name }}"


- name: Ensure Argo CD is installed and list apps
  ansible.builtin.include_role:
    name: common
    tasks_from: argocd_check

- name: Onboard current service to Argo CD if needed
  ansible.builtin.include_tasks: argocd_onboard.yml
