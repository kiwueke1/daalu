- name: Check if Keycloak is already added to Argo CD
  ansible.builtin.debug:
    msg: "Keycloak already onboarded to Argo CD"
  when: "'keycloak' in argocd_apps_list | map('lower') | list"
  delegate_to: localhost
  run_once: true

- name: Download and apply Keycloak Argo CD app if not already present
  block:
    - name: Download Argo CD app manifest via GitHub v3 API
      ansible.builtin.uri:
        url: "https://api.github.com/repos/kiwueke1/argocd-infrastructure-app/contents/apps/keycloak/keycloak.yaml"
        method: GET
        return_content: true
        headers:
          Accept: "application/vnd.github.v3.raw"
          Authorization: "token {{ github_token }}"
      register: keycloak_raw_yaml
      delegate_to: localhost
      run_once: true

    - name: Write Argo CD app manifest to file
      ansible.builtin.copy:
        dest: /tmp/keycloak-argocd-app.yaml
        content: "{{ keycloak_raw_yaml.content }}"
      delegate_to: localhost
      run_once: true

    - name: Apply Keycloak Argo CD app
      ansible.builtin.command:
        cmd: kubectl apply --kubeconfig {{ kubeconfig_path_local }} -f /tmp/keycloak-argocd-app.yaml
      register: apply_keycloak_argocd
      changed_when: "'configured' in apply_keycloak_argocd.stdout or 'created' in apply_keycloak_argocd.stdout"
      delegate_to: localhost
      run_once: true

  when: "'keycloak' not in argocd_apps_list | map('lower') | list"
