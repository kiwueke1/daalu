# Copyright (c) 2022 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Include defaults role
  ansible.builtin.include_role:
    name: defaults

- name: Verify chart path exists
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../../../charts/{{ openstack_helm_endpoints_chart }}/values.yaml"
  register: chart_file
  when: openstack_helm_endpoints_chart is defined

- name: Fail if chart not found
  ansible.builtin.fail:
    msg: "Chart values.yaml not found at expected location: {{ playbook_dir }}/../../../charts/{{ openstack_helm_endpoints_chart }}/values.yaml"
  when: 
    - openstack_helm_endpoints_chart is defined
    - not chart_file.stat.exists

- name: Retrieve list of all the needed endpoints
  ansible.builtin.set_fact:
    openstack_helm_endpoints_list: "{{ lookup('ansible.builtin.file', playbook_dir + '/../../../charts/' + openstack_helm_endpoints_chart + '/values.yaml', split_lines=False) | from_yaml | community.general.json_query('keys(endpoints)') | difference(_openstack_helm_endpoints_ignore) }}"
  vars:
    charts_path: "{{ playbook_dir }}/../../../charts"
  when:
    - openstack_helm_endpoints_chart is defined
  register: endpoint_result
  ignore_errors: true

- name: Debug endpoint retrieval
  ansible.builtin.debug:
    msg: "Retrieved endpoints: {{ endpoint_result }}"
  when: endpoint_result is defined

- name: Show openstack_helm_endpoints_list
  ansible.builtin.debug:
    msg: "Configuring oslo.messaging for: {{ openstack_helm_endpoints_list }}"

- name: Configure "oslo.messaging"
  when:
    - '"oslo_messaging" in openstack_helm_endpoints_list'
  block:
    - name: Create RabbitMQ cluster
      ansible.builtin.include_role:
        name: rabbitmq
      vars:
        rabbitmq_cluster_name: "{{ openstack_helm_endpoints_chart }}"

    - name: Grab RabbitMQ cluster secret
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "rabbitmq-{{ openstack_helm_endpoints_chart }}-default-user"
        namespace: openstack
        kubeconfig: "{{ atmosphere_kubeconfig }}"
      register: _openstack_helm_endpoints_rabbitmq_cluster_secret

    - name: Cache fact with RabbitMQ cluster credentials
      ansible.builtin.set_fact:
        _openstack_helm_endpoints_rabbitmq_cluster_username: "{{ _openstack_helm_endpoints_rabbitmq_cluster_secret.resources[0]['data']['username'] | b64decode }}"
        _openstack_helm_endpoints_rabbitmq_cluster_password: "{{ _openstack_helm_endpoints_rabbitmq_cluster_secret.resources[0]['data']['password'] | b64decode }}"

- name: Configure "oslo.db"
  when:
    - '"oslo_db" in openstack_helm_endpoints_list'
    - openstack_helm_endpoints_mariadb_admin_password is not defined
  block:
    - name: Grab Percona XtraDB cluster secret
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: percona-xtradb
        namespace: openstack
        kubeconfig: "{{ atmosphere_kubeconfig }}"
      register: _openstack_helm_endpoints_oslo_db_secret

    - name: Cache fact with Percona XtraDB password
      ansible.builtin.set_fact:
        openstack_helm_endpoints_mariadb_admin_password: "{{ _openstack_helm_endpoints_oslo_db_secret.resources[0]['data']['root'] | b64decode }}"

- name: Reset value for OpenStack_Helm endpoints
  ansible.builtin.set_fact:
    openstack_helm_endpoints: "{{ openstack_helm_endpoints_config }}"

- name: Generate OpenStack-Helm endpoints
  ansible.builtin.set_fact:
    openstack_helm_endpoints: "{{ openstack_helm_endpoints | combine(lookup('vars', '_openstack_helm_endpoints_' + service), recursive=True) }}"
  loop: "{{ openstack_helm_endpoints_list }}"
  loop_control:
    loop_var: service

- name: Clean-up facts
  ansible.builtin.set_fact:
    openstack_helm_endpoints_list: []


































